<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISC Chatbot</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #3d6cb9 100%);
            color: #2c3e50;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            top: -200px;
            right: -200px;
            pointer-events: none;
        }

        body::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            bottom: -150px;
            left: -150px;
            pointer-events: none;
        }

        #app {
            flex: 1;
            display: flex;
            flex-direction: column;
            z-index: 2;
            position: relative;
            height: 100vh;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.18);
        }

        header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }

        header .tagline {
            font-size: 12px;
            color: #6b7280;
        }

        #info-bar {
            background: rgba(6, 95, 223, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        #info-label {
            font-size: 13px;
            color: #ffffff; 
            font-weight: 500;
        }

        #kategori-select {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.9);
            font-size: 13px;
            background: rgba(255, 255, 255, 0.95);
            outline: none;
            min-width: 220px;
        }

        #chat-container {
            flex: 1;
            padding: 18px 20px;
            overflow-y: auto;
            background:
                radial-gradient(circle at top left, rgba(255, 255, 255, 0.08) 0, transparent 55%),
                radial-gradient(circle at bottom right, rgba(15, 23, 42, 0.20) 0, transparent 60%);
        }

        /* ROW UNTUK SATU PESAN (bisa berisi avatar + bubble) */
        .msg-row {
            display: flex;
            margin-bottom: 12px;
        }

        .msg-row.bot-row {
            justify-content: flex-start;
            align-items: flex-start;
            gap: 8px;
        }

        .msg-row.user-row {
            justify-content: flex-end;
        }

        /* AVATAR BOT */
        .bot-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            object-fit: cover;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.75);
            background: #0f172a;
        }

        .msg {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.15);
            
        }

        .user-msg {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #e5f0ff;
            border-bottom-right-radius: 4px;
        }

        .bot-msg {
            background: rgba(255, 255, 255, 0.95);
            color: #111827;
            border-bottom-left-radius: 4px;
        }

        #input-box {
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.88);
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid rgba(148, 163, 184, 0.4);
        }

        #query {
            flex: 1;
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.8);
            outline: none;
            font-size: 14px;
            background: rgba(15, 23, 42, 0.95);
            color: #e5e7eb;
        }

        #query::placeholder {
            color: #9ca3af;
        }

        #send-btn {
            padding: 10px 20px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #facc15, #eab308);
            color: #1f2937;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(250, 204, 21, 0.35);
            transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
            white-space: nowrap;
        }

        #send-btn:hover {
            filter: brightness(1.05);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(250, 204, 21, 0.5);
        }

        #send-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(250, 204, 21, 0.35);
        }

        /* scrollbar */
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: transparent;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.7);
            border-radius: 999px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .msg {
                max-width: 85%;
            }

            header h1 {
                font-size: 18px;
            }

            #send-btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            #query {
                padding: 10px 12px;
                font-size: 13px;
            }

            #kategori-select {
                min-width: 180px;
            }

            .bot-avatar {
                width: 28px;
                height: 28px;
            }
        }
    </style>

    <!-- KaTeX: CSS & JS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</head>

<body>
    <div id="app">
        <header>
            <div>
                <h1>ISC Chatbot</h1>
                <div class="tagline">Asisten belajar berbasis RAG untuk materi Informatika</div>
            </div>
        </header>

        <div id="info-bar">
            <span id="info-label">Mode: General (semua semester)</span>
            <select id="kategori-select">
                <option value="">General (semua semester)</option>
                <option value="wajib_1">Wajib Semester 1</option>
                <option value="wajib_2">Wajib Semester 2</option>
                <option value="wajib_3">Wajib Semester 3</option>
                <option value="wajib_4">Wajib Semester 4</option>
                <option value="wajib_5">Wajib Semester 5</option>
                <option value="wajib_6">Wajib Semester 6</option>
                <option value="pilihan_ganjil">Mata Kuliah Pilihan Ganjil</option>
                <option value="pilihan_genap">Mata Kuliah Pilihan Genap</option>
            </select>
        </div>

        <div id="chat-container"></div>

        <div id="input-box">
            <input
                type="text"
                id="query"
                placeholder="Ketik pertanyaan Anda di sini..."
                autocomplete="off"
            >
            <button id="send-btn">Kirim</button>
        </div>
    </div>

    <script>
        const appPage = document.getElementById("app");
        const chatBox = document.getElementById("chat-container");
        const queryInput = document.getElementById("query");
        const infoLabel = document.getElementById("info-label");
        const kategoriSelect = document.getElementById("kategori-select");

        // "" = mode general
        let selectedKategori = "";

        const labelMap = {
            "wajib_1": "Wajib Semester 1",
            "wajib_2": "Wajib Semester 2",
            "wajib_3": "Wajib Semester 3",
            "wajib_4": "Wajib Semester 4",
            "wajib_5": "Wajib Semester 5",
            "wajib_6": "Wajib Semester 6",
            "pilihan_ganjil": "Mata Kuliah Pilihan Ganjil",
            "pilihan_genap": "Mata Kuliah Pilihan Genap"
        };

        infoLabel.textContent = "Mode: General (semua semester)";

        // perubahan dropdown
        kategoriSelect.addEventListener("change", () => {
            selectedKategori = kategoriSelect.value;

            if (!selectedKategori) {
                infoLabel.textContent = "Mode: General (semua semester)";
            } else {
                infoLabel.textContent = "Kategori: " + (labelMap[selectedKategori] || selectedKategori);
            }
        });

        // Fungsi untuk menambah pesan ke chat (sekarang pakai row + avatar untuk bot)
        function addMessage(text, isUser) {
            const row = document.createElement("div");
            row.className = "msg-row " + (isUser ? "user-row" : "bot-row");

            const bubble = document.createElement("div");
            bubble.className = "msg " + (isUser ? "user-msg" : "bot-msg");

            if (isUser) {
                bubble.textContent = text;
                row.appendChild(bubble);
            } else {
                // avatar bot
                const avatar = document.createElement("img");
                avatar.className = "bot-avatar";
                avatar.src = "/static/isc.jpg"; 
                avatar.alt = "Bot";

                bubble.innerHTML = text;

                row.appendChild(avatar);
                row.appendChild(bubble);

                // Render LaTeX dengan KaTeX
                if (window.renderMathInElement) {
                    renderMathInElement(bubble, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$",  right: "$",  display: false }
                        ]
                    });
                }
            }

            chatBox.appendChild(row);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendQuery() {
            const query = queryInput.value.trim();
            if (!query) return;

            addMessage(query, true);
            queryInput.value = "";
            
            try {
                const payload = { query: query };
                // kalau user pilih kategori -> kirim; kalau tidak -> mode general
                if (selectedKategori) {
                    payload.kategori = selectedKategori;
                }

                const res = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401) {
                    const data401 = await res.json();
                    addMessage(
                        data401.error || "Silakan login terlebih dahulu sebelum mulai chat.",
                        false
                    );
                    return;
                }

                const data = await res.json();
                if (data.response) {
                    addMessage(data.response, false);
                } else {
                    addMessage("Error: " + (data.error || "Terjadi kesalahan di server."), false);
                }
            } catch (err) {
                addMessage("Network error: " + err.message, false);
            }
        }

        // Enter untuk kirim
        queryInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendQuery();
        });

        document.getElementById("send-btn").addEventListener("click", sendQuery);

        // Render math yang mungkin sudah ada saat halaman pertama kali load
        document.addEventListener("DOMContentLoaded", () => {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        { left: "$$", right: "$$", display: true },
                        { left: "$",  right: "$",  display: false }
                    ]
                });
            }
        });
    </script>
</body>
</html>
